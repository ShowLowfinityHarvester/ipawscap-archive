<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:title" content="WSLF IPAWS CAP Archive">
  <meta property="og:description" content="Daily archive of IPAWS CAP alerts captured by the WSLF CAPDEC.">
  <meta property="og:image" content="https://wslf-radio.neocities.org/WSLF_Transparent.png">
  <title>WSLF Radio IPAWSCAP Archive</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* ====== YOUR LOOK & FEEL ====== */
    body { margin:0; padding:0; font-family:'Roboto',sans-serif; background:#2a2a2a; color:#f0f0f0; line-height:1.6; overflow-x:hidden; }

    .menu-bar { position:fixed; top:0; left:0; background:#3a3a3a; display:flex; justify-content:space-between; align-items:center; padding:10px; width:100%; z-index:1000; box-shadow:0 2px 10px rgba(0,0,0,.6); }
    .menu-bar img{ width:50px; margin-right:20px; }
    .menu-items{ display:flex; align-items:center; flex-wrap:nowrap; overflow:hidden; }
    .menu-item{ margin-right:20px; cursor:pointer; color:#e0e0e0; text-decoration:none; font-weight:500; padding:8px 12px; border-radius:6px; transition:.2s; white-space:nowrap; }
    .menu-item:hover{ background:#fff; color:#000; }

    .content{ max-width:1100px; margin:80px auto 30px auto; padding:25px; background:rgba(0,0,0,.9); border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.6); }
    h1{ margin:0 0 10px 0; text-align:center; font-weight:500; }
    .sub{ opacity:.8; text-align:center; margin:0 0 20px 0; }

    .controls{ display:flex; gap:8px; justify-content:center; align-items:center; margin:10px 0 20px 0; flex-wrap:wrap; }
    .btn{ background:#3a3a3a; border:1px solid #555; color:#e0e0e0; border-radius:6px; padding:8px 12px; cursor:pointer; }
    .btn:hover{ background:#fff; color:#000; }
    .date-chip{ background:#555; color:#fff; border-radius:16px; padding:6px 12px; font-weight:500; }
    input[type=date]{ background:#2a2a2a; border:1px solid #555; color:#f0f0f0; border-radius:6px; padding:8px 10px; }

    table{ border-collapse:collapse; width:100%; margin-top:10px; }
    th,td{ border:1px solid #555; padding:.75rem; vertical-align:top; }
    thead th{ background:#232323; }
    tbody tr:hover{ background:#3a3a3a; }

    .badge{ display:inline-block; padding:.25rem .5rem; border-radius:.35rem; font-size:.9rem; font-weight:700; background:#314964; border:1px solid #223145; }
    .muted{ color:#a8b3c4; }
    .eas-cell{ max-width:850px; white-space:normal; }
    details{ background:#1f1f1f; border:1px solid #555; border-radius:8px; padding:10px; margin-top:8px; }
    summary{ cursor:pointer; color:#cfd7e4; }

    audio{ width:100%; margin-top:10px; }

    @media (max-width:768px){
      .content{ margin:70px 20px 20px 20px; padding:20px; }
      .menu-bar img{ width:40px; }
      .menu-item{ margin-right:15px; font-size:14px; }
      .eas-cell{ max-width:none; }
    }
  </style>
</head>
<body>
  <!-- top bar -->
  <div class="menu-bar">
    <div style="display:flex;align-items:center;">
      <img src="/WSLF.png" alt="WSLF Logo">
      <div class="menu-items">
        <div class="menu-item" onclick="location.href='/'"><i class="fas fa-home"></i> Home</div>
        <div class="menu-item" onclick="location.href='/about'"><i class="fas fa-info-circle"></i> About</div>
        <div class="menu-item" onclick="location.href='/alerts/'"><i class="fas fa-bullhorn"></i> IPAWS Archive</div>
      </div>
    </div>
  </div>

  <div class="content">
    <h1>IPAWS CAP Archive</h1>
    <p class="sub">WSLF Radio's CAP Archive</p>

    <div class="controls">
      <button id="prev" class="btn"><i class="fas fa-chevron-left"></i> Prev Day</button>
      <span id="chip" class="date-chip">Loading…</span>
      <button id="next" class="btn">Next Day <i class="fas fa-chevron-right"></i></button>
      <input id="picker" type="date">
      <button id="today" class="btn">Today</button>
    </div>

    <table id="tbl">
      <thead>
        <tr>
          <th style="width:110px">Event</th>
          <th>EAS Text</th>
          <th style="width:165px">Sent (UTC)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="noData" class="muted" style="text-align:center; padding:18px;" hidden>
      No alerts for this day.
    </div>
  </div>

  <script>
    // Phoenix (UTC-7) "day" selection
    const PHX_OFFSET_MIN = 7*60;
    function toPhoenixDate(d){ const utc=new Date(d.getTime()+d.getTimezoneOffset()*60000); return new Date(utc.getTime()-PHX_OFFSET_MIN*60000); }
    function ymdParts(d){ return {y:d.getUTCFullYear(), m:String(d.getUTCMonth()+1).padStart(2,'0'), d:String(d.getUTCDate()).padStart(2,'0')}; }
    function addDays(d,n){ const x=new Date(d); x.setUTCDate(x.getUTCDate()+n); return x; }
    function pathDateOrToday(){
      const m = location.pathname.match(/\/alerts\/(\d{4})\/(\d{2})\/(\d{2})\//);
      if(m) return new Date(Date.UTC(+m[1], +m[2]-1, +m[3]));
      const phx = toPhoenixDate(new Date());
      return new Date(Date.UTC(phx.getUTCFullYear(), phx.getUTCMonth(), phx.getUTCDate()));
    }

    let currentDayUTC = pathDateOrToday();
    const elChip   = document.getElementById('chip');
    const elPrev   = document.getElementById('prev');
    const elNext   = document.getElementById('next');
    const elPicker = document.getElementById('picker');
    const elToday  = document.getElementById('today');
    const tbody    = document.querySelector('#tbl tbody');
    const noData   = document.getElementById('noData');

    function setChip(dUTC){
      const s = dUTC.toISOString().slice(0,10);
      elChip.textContent = s + ' (Arizona/Phoenix)';
      elPicker.value = s;
    }

    async function loadDay(dUTC){
      const {y,m,d} = ymdParts(dUTC);
      const base = `/alerts/${y}/${m}/${d}/`;
      tbody.innerHTML = ''; noData.hidden = true;

      const r = await fetch(base+'index.json', {cache:'no-cache'});
      if(!r.ok){ noData.hidden=false; return; }
      const data = await r.json();
      const list = (data.alerts||[]).slice().sort((a,b)=>a.sent_utc.localeCompare(b.sent_utc));
      if(list.length===0){ noData.hidden=false; return; }

      const cache = Object.create(null); // detail json cache

      for(const a of list){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><span class="badge">${a.event_code||''}</span></td>
          <td class="eas-cell"><span class="muted">loading…</span></td>
          <td>${a.sent_utc||''}</td>`;
        tbody.appendChild(tr);

        const cell = tr.children[1];
        const detailUrl = base + (a.href || `${a.id}.json`);

        (async ()=>{
          try{
            if(!cache[detailUrl]){
              const rr = await fetch(detailUrl, {cache:'no-cache'});
              if(!rr.ok) throw new Error('detail not found');
              cache[detailUrl] = await rr.json();
            }
            const j = cache[detailUrl];
            const eas = (j.eas_text||'').trim();
            const extra = (j.extra_text||'').trim();
            const preview = eas.length>300 ? eas.slice(0,300)+'…' : eas;

            cell.innerHTML = `
              <div>${preview||'<span class="muted">(no EAS text)</span>'}</div>
              <details>
                <summary>Show full text & audio</summary>
                <div style="margin-top:8px;">
                  <div><strong>EAS Text</strong></div>
                  <div style="white-space:pre-wrap">${eas||'<span class="muted">(none)</span>'}</div>
                  <div style="margin-top:10px;"><strong>Extra Text</strong></div>
                  <div style="white-space:pre-wrap">${extra||'<span class="muted">(none)</span>'}</div>
                  ${j.audio_url ? `<audio controls src="${j.audio_url}"></audio>` : ''}
                </div>
              </details>`;
          }catch{
            cell.innerHTML = '<span class="muted">unavailable</span>';
          }
        })();
      }
    }

    function go(n){
      currentDayUTC = addDays(currentDayUTC, n);
      setChip(currentDayUTC);
      loadDay(currentDayUTC);
      if(location.pathname.match(/^\/alerts\/\d{4}\/\d{2}\/\d{2}\/$/)){
        const {y,m,d}=ymdParts(currentDayUTC);
        history.replaceState({}, '', `/alerts/${y}/${m}/${d}/`);
      }
    }

    elPrev.onclick = ()=>go(-1);
    elNext.onclick = ()=>go(+1);
    elToday.onclick = ()=>{ currentDayUTC = pathDateOrToday(); setChip(currentDayUTC); loadDay(currentDayUTC); };
    elPicker.onchange = ()=>{ const d=new Date(elPicker.value+'T00:00:00Z'); if(!isNaN(d)){ currentDayUTC=d; setChip(d); loadDay(d); } };

    setChip(currentDayUTC);
    loadDay(currentDayUTC);
  </script>
</body>
</html>
